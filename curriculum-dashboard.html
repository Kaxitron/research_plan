<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Path to AI Alignment — Curriculum Navigator</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap');

  :root {
    --bg: #0a0a0f;
    --bg-raised: #12121a;
    --bg-panel: #16161f;
    --bg-hover: #1e1e2a;
    --border: #2a2a3a;
    --border-bright: #3a3a5a;
    --text: #e0e0ec;
    --text-dim: #8888a0;
    --text-bright: #ffffff;
    --accent-1: #6ee7b7;
    --accent-2: #818cf8;
    --accent-3: #f9a8d4;
    --accent-4: #fbbf24;
    --accent-5: #38bdf8;
    --accent-6: #c084fc;
    --accent-7: #fb923c;
    --complete: #34d399;
    --in-progress: #fbbf24;
    --not-started: #4a4a6a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    overflow: hidden;
    height: 100vh;
  }

  .app {
    display: grid;
    grid-template-columns: 280px 1fr 380px;
    grid-template-rows: auto 1fr;
    height: 100vh;
  }

  /* Header */
  .header {
    grid-column: 1 / -1;
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--bg-raised);
  }
  .header h1 {
    font-family: 'Instrument Serif', serif;
    font-size: 20px;
    font-weight: 400;
    color: var(--text-bright);
  }
  .header h1 span { color: var(--accent-1); }
  .header-stats {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .header-stats .stat-value {
    font-family: 'JetBrains Mono', monospace;
    color: var(--text);
    font-weight: 600;
  }
  .progress-bar-container {
    width: 180px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-1), var(--accent-5));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* Sidebar */
  .sidebar {
    background: var(--bg-raised);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    padding: 12px 0;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .nav-section-header {
    padding: 10px 16px 6px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    user-select: none;
  }
  .nav-section-header:hover { background: var(--bg-hover); }
  .nav-section-header .chevron {
    transition: transform 0.2s;
    font-size: 8px;
  }
  .nav-section-header .chevron.collapsed { transform: rotate(-90deg); }

  .nav-item {
    padding: 6px 16px 6px 24px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dim);
    transition: all 0.15s;
  }
  .nav-item:hover { background: var(--bg-hover); color: var(--text); }
  .nav-item.active { background: var(--bg-hover); color: var(--text-bright); }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.15s;
  }
  .status-dot:hover { transform: scale(1.4); }

  .nav-item-checkpoint {
    padding: 5px 16px 5px 32px;
    font-size: 11px;
    color: var(--text-dim);
    cursor: pointer;
    font-style: italic;
    opacity: 0.7;
  }
  .nav-item-checkpoint:hover { opacity: 1; background: var(--bg-hover); }

  /* Main Canvas */
  .main-canvas {
    position: relative;
    overflow: hidden;
    background: var(--bg);
  }
  .canvas-controls {
    position: absolute;
    top: 12px;
    left: 12px;
    z-index: 10;
    display: flex;
    gap: 4px;
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px;
  }
  .canvas-btn {
    padding: 5px 12px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    background: transparent;
    color: var(--text-dim);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .canvas-btn:hover { color: var(--text); background: var(--bg-hover); }
  .canvas-btn.active { color: var(--text-bright); background: var(--bg-hover); }

  .canvas-legend {
    position: absolute;
    bottom: 12px;
    left: 12px;
    display: flex;
    gap: 14px;
    font-size: 11px;
    color: var(--text-dim);
    z-index: 10;
  }
  .legend-item { display: flex; align-items: center; gap: 5px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

  svg.graph { width: 100%; height: 100%; }

  .edge {
    stroke: var(--border);
    stroke-width: 1.2;
    opacity: 0.4;
    transition: all 0.3s;
  }
  .edge.highlighted { stroke: var(--accent-5); opacity: 0.9; stroke-width: 2; }
  .edge-cross-phase {
    stroke-dasharray: 6 4;
    opacity: 0.2;
  }
  .edge-cross-phase.highlighted { opacity: 0.6; stroke: var(--accent-6); }

  .node-group { cursor: pointer; }
  .node-circle {
    stroke-width: 2;
    transition: all 0.2s;
  }
  .node-group:hover .node-circle { stroke-width: 3; filter: brightness(1.3); }
  .node-number {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    text-anchor: middle;
    pointer-events: none;
  }

  /* Detail Panel */
  .detail-panel {
    background: var(--bg-panel);
    border-left: 1px solid var(--border);
    overflow-y: auto;
    padding: 20px;
  }
  .detail-panel::-webkit-scrollbar { width: 4px; }
  .detail-panel::-webkit-scrollbar-track { background: transparent; }
  .detail-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .detail-empty {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-dim);
    font-size: 13px;
    padding: 20px;
  }
  .empty-icon { font-size: 32px; margin-bottom: 12px; opacity: 0.3; }

  .detail-header { margin-bottom: 16px; }
  .detail-phase-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
  }
  .detail-title {
    font-size: 18px;
    font-weight: 600;
    color: var(--text-bright);
    line-height: 1.3;
    margin-bottom: 8px;
  }
  .detail-meta {
    display: flex;
    gap: 16px;
    font-size: 12px;
    color: var(--text-dim);
  }
  .detail-section {
    margin-bottom: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }
  .detail-section-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dim);
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .detail-section-title .icon { font-size: 13px; }

  .prereq-list, .concept-check-list, .failure-list, .project-list {
    list-style: none;
    padding: 0;
  }
  .prereq-list li, .concept-check-list li, .failure-list li {
    font-size: 12px;
    padding: 4px 0;
    line-height: 1.5;
    color: var(--text);
  }
  .concept-check-list li::before { content: "□ "; color: var(--accent-5); font-weight: bold; }
  .failure-list li::before { content: "⚠ "; }

  .prereq-link {
    color: var(--accent-5);
    cursor: pointer;
    font-weight: 500;
    border-bottom: 1px dashed var(--accent-5);
  }
  .prereq-link:hover { color: var(--text-bright); }

  .mvl-resource {
    font-size: 12px;
    padding: 6px 0;
    line-height: 1.5;
  }
  .res-type {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    font-weight: 700;
    color: var(--accent-4);
    display: inline;
    margin-right: 6px;
  }

  .project-item {
    font-size: 12px;
    padding: 4px 0;
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }
  .project-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 8px;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 3px;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .project-badge.new { background: rgba(56,189,248,0.15); color: var(--accent-5); }
  .project-badge.extends { background: rgba(192,132,252,0.15); color: var(--accent-6); }

  .mobile-close-btn {
    display: none;
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bg-panel);
    border: 1px solid var(--border);
    color: var(--text-dim);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    margin-bottom: 12px;
    width: 100%;
  }
  .mobile-close-btn:hover { color: var(--text); background: var(--bg-hover); }

  .detail-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 99;
  }
  .detail-backdrop.open { display: block; }

  /* Responsive */
  @media (max-width: 1100px) {
    .app { grid-template-columns: 240px 1fr 320px; }
  }

  @media (max-width: 900px) {
    .app {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
    }
    .sidebar { display: none; }
    .header h1 { font-size: 16px; }
    .header-stats { gap: 10px; font-size: 11px; }
    .header { padding: 10px 14px; flex-wrap: wrap; gap: 6px; }
    .main-canvas { overflow: auto; -webkit-overflow-scrolling: touch; }
    svg.graph { min-width: 900px; min-height: 700px; }

    .detail-panel {
      display: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      max-height: 55vh;
      z-index: 100;
      border-left: none;
      border-top: 2px solid var(--accent-5);
      border-radius: 12px 12px 0 0;
      padding: 12px 16px;
      animation: slideUp 0.25s ease;
      overflow-y: auto;
    }
    .detail-panel.mobile-open { display: block; }
    .mobile-close-btn { display: flex; align-items: center; justify-content: center; }
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  /* Calendar styles */
  .cal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px 12px;
  }
  .cal-nav {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .cal-nav:hover { color: var(--text); border-color: var(--border-bright); background: var(--bg-hover); }
  .cal-month-label {
    font-family: 'Instrument Serif', serif;
    font-size: 20px;
    color: var(--text-bright);
  }
  .cal-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    padding: 0 20px 20px;
    flex: 1;
    min-height: 0;
  }
  .cal-dow {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    text-align: center;
    padding: 4px 0 8px;
    letter-spacing: 1px;
  }
  .cal-day {
    background: var(--bg-raised);
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 4px;
    min-height: 72px;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    overflow: hidden;
  }
  .cal-day:hover { border-color: var(--border-bright); background: var(--bg-hover); }
  .cal-day.empty { background: transparent; cursor: default; border: none; }
  .cal-day.empty:hover { background: transparent; }
  .cal-day.today { border-color: var(--accent-5); box-shadow: 0 0 0 1px rgba(56,189,248,0.2); }
  .cal-day.selected { border-color: var(--accent-5); background: rgba(56,189,248,0.06); }
  .cal-day-num {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-dim);
    margin-bottom: 3px;
  }
  .cal-day.today .cal-day-num { color: var(--accent-5); }
  .cal-chip {
    display: flex;
    align-items: center;
    gap: 3px;
    padding: 2px 5px;
    margin-bottom: 2px;
    border-radius: 3px;
    font-size: 10px;
    font-family: 'JetBrains Mono', monospace;
    cursor: pointer;
    transition: filter 0.15s;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .cal-chip:hover { filter: brightness(1.3); }
  .cal-chip-num {
    font-weight: 700;
    flex-shrink: 0;
  }
  .cal-chip-title {
    font-family: 'DM Sans', sans-serif;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cal-unscheduled {
    padding: 12px 20px;
    border-top: 1px solid var(--border);
  }
  .cal-unscheduled-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 600;
    color: var(--text-dim);
    letter-spacing: 1px;
    margin-bottom: 8px;
  }
  .cal-pool-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    margin: 2px 3px;
    border-radius: 4px;
    font-size: 11px;
    cursor: grab;
    transition: all 0.15s;
    border: 1px solid transparent;
    user-select: none;
  }
  .cal-pool-chip:hover { border-color: var(--border-bright); filter: brightness(1.2); }
  .cal-pool-chip.dragging { opacity: 0.5; }
  .cal-day.drag-over { border-color: var(--accent-5) !important; background: rgba(56,189,248,0.1) !important; }

  /* Picker in detail panel */
  .picker-lesson {
    padding: 6px 8px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.15s;
  }
  .picker-lesson:hover { background: var(--bg-hover); }
  .picker-lesson-num {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    font-weight: 700;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
  }
  .picker-hours {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
    margin-left: auto;
  }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>The Path to <span>AI Alignment</span></h1>
    <div class="header-stats">
      <div>
        <span class="stat-value" id="stat-complete">0</span>/<span class="stat-value" id="stat-total">0</span> lessons
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
        </div>
      </div>
      <div>
        ~<span class="stat-value" id="stat-hours-done">0</span>h done · ~<span class="stat-value" id="stat-hours-left">0</span>h remaining
      </div>
    </div>
  </div>

  <div class="sidebar" id="sidebar"></div>

  <div class="main-canvas" id="main-canvas">
    <div class="canvas-controls">
      <button class="canvas-btn active" onclick="setView('dependency')">Dependency Map</button>
      <button class="canvas-btn" onclick="setView('timeline')">Timeline</button>
      <button class="canvas-btn" onclick="setView('calendar')">Calendar</button>
    </div>
    <div class="canvas-legend" id="canvas-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--complete)"></div> Complete</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--in-progress)"></div> In Progress</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--not-started)"></div> Not Started</div>
      <div class="legend-item" style="color:var(--text-dim)">— prerequisite</div>
      <div class="legend-item" style="color:var(--text-dim)">┄ cross-phase</div>
    </div>
    <svg class="graph" id="graph-svg"></svg>
    <div id="calendar-view" style="display:none;position:absolute;inset:0;overflow-y:auto;background:var(--bg)"></div>
  </div>

  <div class="detail-backdrop" id="detail-backdrop" onclick="closeMobileDetail()"></div>

  <div class="detail-panel" id="detail-panel">
    <button class="mobile-close-btn" onclick="closeMobileDetail()">✕ Close</button>
    <div class="detail-empty" id="detail-empty">
      <div class="empty-icon">◇</div>
      <p>Click any lesson node to view details, concept checks, failure modes, and prerequisites.</p>
    </div>
    <div id="detail-content" style="display:none"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════════

const PHASES = [
  { id: 'p0', name: 'Setup', color: '#94a3b8', hours: '2–4h' },
  { id: 'p1', name: 'Linear Algebra', color: '#6ee7b7', hours: '22–30h' },
  { id: 'p2', name: 'Calculus for ML', color: '#818cf8', hours: '20–28h' },
  { id: 'p3', name: 'Probability & Info Theory', color: '#f9a8d4', hours: '22–30h' },
  { id: 'p4', name: 'Applied Statistics', color: '#f472b6', hours: '18–26h' },
  { id: 'p5', name: 'Math Enrichment', color: '#e879f9', hours: '18–26h' },
  { id: 'p6', name: 'Neural Networks', color: '#fbbf24', hours: '42–58h' },
  { id: 'p7', name: 'Interpretability', color: '#38bdf8', hours: '26–38h' },
  { id: 'p8', name: 'Alignment Theory', color: '#c084fc', hours: '25–35h' },
  { id: 'p9', name: 'Research', color: '#fb923c', hours: '∞' },
];

const LESSONS = [
  // ─── Phase 0: Setup ───
  {
    id: 0, phase: 'p0', title: 'Python and NumPy for Machine Learning',
    status: 'not-started', hours: '2–4h',
    prereqs: [],
    crossPhaseLinks: [],
    conceptChecks: [
      'Can you create a matrix in NumPy and multiply it by a vector with @?',
      'Can you plot vectors as arrows with matplotlib?',
      'Do you understand NumPy broadcasting?',
    ],
    failureModes: [
      'Writing Python for-loops when NumPy vectorized operations exist — always think "whole array at once"',
      'Spending too long here if you already know NumPy — skim and move on',
    ],
    mvl: [
      { type: 'Do', text: 'Multiply two 1000×1000 matrices: for-loops vs A @ B. Feel the 100x speedup.' },
      { type: 'Do', text: 'Plot the unit circle, apply a 2×2 matrix, see the ellipse' },
    ],
    projects: [],
  },
  {
    id: 1, phase: 'p0', title: 'PyTorch — The Language of Alignment Research',
    status: 'not-started', hours: '4–6h',
    prereqs: [0],
    crossPhaseLinks: [],
    conceptChecks: [
      'Can you create a tensor with requires_grad=True and compute gradients via backward()?',
      'Do you understand the training loop pattern: zero_grad → forward → loss → backward → step?',
      'Can you register a forward hook on a module and inspect activations?',
      'Can you use torch.einsum for matrix multiplication and attention scores?',
    ],
    failureModes: [
      'Forgetting torch.no_grad() during inference — causes memory leaks from graph accumulation',
      'Mixing devices (CPU tensor + GPU tensor) — all operations must be on the same device',
      'Using NumPy operations on data that needs gradients — breaks the computation graph',
    ],
    mvl: [
      { type: 'Read', text: 'PyTorch 60-Minute Blitz tutorial' },
      { type: 'Do', text: 'Port a Phase 1 NumPy exercise to PyTorch, verify identical results' },
      { type: 'Do', text: 'Build a minimal training loop: 2-layer MLP on toy data' },
      { type: 'Do', text: 'ARENA Chapter 0.0 einops/einsum exercises' },
    ],
    projects: [
      { text: 'Autograd experiment: manual gradient verification' },
      { text: 'Hook exercise: intercept intermediate activations in a pretrained model' },
    ],
  },
  // ─── Phase 1: Linear Algebra ───
  {
    id: 2, phase: 'p1', title: 'Vectors — What They Actually Are',
    status: 'complete', hours: '2–3h',
    prereqs: [],
    crossPhaseLinks: [],
    conceptChecks: [
      'What\'s the difference between a vector as an arrow vs. a list of numbers?',
      'If you change the basis, do the coordinates change? Does the arrow change?',
      'What does it mean geometrically to multiply a vector by -2?',
    ],
    failureModes: [
      'Thinking coordinates ARE the vector rather than a description relative to a basis',
      'Confusing scalar multiplication with matrix-vector multiplication',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 1 — "Vectors, what even are they?"' },
      { type: 'Do', text: 'Plot v, 2v, -v, and v + [2,2] in matplotlib' },
    ],
    projects: [
      { text: 'Vector plotting toolkit (matplotlib)' },
    ],
  },
  {
    id: 3, phase: 'p1', title: 'Linear Combinations, Span, and Basis',
    status: 'complete', hours: '3–4h',
    prereqs: [2],
    crossPhaseLinks: [],
    conceptChecks: [
      'If two vectors are parallel, what is their span?',
      'How many vectors do you need to span ℝ³?',
      'Can 3 vectors in ℝ² be linearly independent? Why not?',
      'What does it mean for a set of vectors to be a basis?',
    ],
    failureModes: [
      'Confusing "span" (the set of all reachable vectors) with "spanning set" (the vectors doing the spanning)',
      'Thinking you always need exactly n vectors for ℝⁿ — you need n linearly independent vectors',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 2 — "Linear combinations, span, and basis vectors"' },
      { type: 'Do', text: 'Show any 2D point as a linear combination of 2 random non-parallel vectors' },
    ],
    projects: [
      { text: 'Add span visualization to vector toolkit' },
    ],
  },
  {
    id: 4, phase: 'p1', title: 'Linear Transformations and Matrices',
    status: 'complete', hours: '3–5h',
    prereqs: [3],
    crossPhaseLinks: [],
    conceptChecks: [
      'What does "the columns of a matrix are where the basis vectors land" mean?',
      'If a matrix\'s columns are parallel, what happens to 2D space?',
      'Why do lines stay lines under a linear transformation?',
      'Given a specific matrix, can you visualize what it does before computing anything?',
    ],
    failureModes: [
      'Thinking of a matrix as "just a grid of numbers" rather than a transformation',
      'Forgetting that matrix-vector multiplication IS applying a transformation',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 3 — "Linear transformations and matrices" (THE key video)' },
      { type: 'Do', text: 'Plot a grid before and after transformation by various 2×2 matrices' },
    ],
    projects: [
      { text: 'Add transformation visualization (grid before/after)' },
    ],
  },
  {
    id: 5, phase: 'p1', title: 'Matrix Operations Deep Dive',
    status: 'complete', hours: '3–4h',
    prereqs: [4],
    crossPhaseLinks: [],
    conceptChecks: [
      'Explain both the row-dot-product and column-linear-combination views of Ax',
      'Why is AB ≠ BA in general? Give a geometric reason.',
      'What does (AB)ᵀ = BᵀAᵀ mean about the order of composed operations?',
    ],
    failureModes: [
      'Only knowing one view of matrix multiplication — you need BOTH (row and column) to read interp papers',
      'Assuming matrix multiplication is commutative like scalar multiplication',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 3–4 (re-watch with both multiplication views in mind)' },
      { type: 'Do', text: 'Implement matrix multiply two ways: row-dot and column-combination' },
    ],
    projects: [
      { text: 'Matrix multiplication from scratch (Python, no NumPy)' },
    ],
  },
  {
    id: 6, phase: 'p1', title: 'Rank, Null Space, and Column Space',
    status: 'complete', hours: '4–5h',
    prereqs: [4, 5],
    crossPhaseLinks: [],
    conceptChecks: [
      'If a 3×3 matrix has rank 2, what dimension does it map 3D space onto?',
      'State the rank-nullity theorem and explain what it means about information.',
      'If Ax = 0 has only the trivial solution, what is the rank?',
    ],
    failureModes: [
      'Confusing column space (set of outputs) with null space (inputs that map to zero)',
      'Forgetting that rank-deficient means information is lost PERMANENTLY',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 7 — "Inverse matrices, column space, null space"' },
      { type: 'Do', text: 'Create a rank-2 matrix in ℝ³, visualize the squished plane' },
    ],
    projects: [
      { text: 'Add rank/nullspace visualization to transformation toolkit' },
    ],
  },
  {
    id: 7, phase: 'p1', title: 'The Determinant',
    status: 'complete', hours: '2–3h',
    prereqs: [4, 6],
    crossPhaseLinks: [],
    conceptChecks: [
      'What does det(A) = 0 tell you geometrically? Algebraically? About invertibility?',
      'If det(A) = -3, what happened to area AND orientation?',
      'Why does det(AB) = det(A)·det(B) make geometric sense?',
    ],
    failureModes: [
      'Memorizing the formula without understanding it as area/volume scaling',
      'Forgetting that det=0, rank-deficient, non-invertible, and non-trivial null space are ALL the same thing',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 6 — "The determinant"' },
      { type: 'Do', text: 'Visualize unit square deformation and measure area vs determinant' },
    ],
    projects: [],
  },
  {
    id: 8, phase: 'p1', title: 'Eigenvalues and Eigenvectors',
    status: 'complete', hours: '4–6h',
    prereqs: [6, 7],
    crossPhaseLinks: [],
    conceptChecks: [
      'What is special about an eigenvector geometrically?',
      'If λ = 0, what does that tell you about the matrix?',
      'What does A = PDP⁻¹ mean in words? (Three steps)',
      'Why does diagonalization make computing Aⁿ trivial?',
    ],
    failureModes: [
      'Confusing eigenvectors (directions that only scale) with singular vectors (SVD directions) — they are NOT the same for non-symmetric matrices',
      'Thinking all matrices can be diagonalized — some can\'t (defective matrices)',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 14 — "Eigenvectors and eigenvalues"' },
      { type: 'Do', text: 'Find eigenvalues/vectors of 2×2 matrices, visualize invariant directions' },
    ],
    projects: [
      { text: 'Add eigenvector visualization to transformation toolkit' },
    ],
  },
  {
    id: 9, phase: 'p1', title: 'Singular Value Decomposition (SVD)',
    status: 'in-progress', hours: '5–7h',
    prereqs: [8],
    crossPhaseLinks: [],
    conceptChecks: [
      'What does A = UΣVᵀ mean as three geometric steps?',
      'How is SVD different from eigendecomposition? When do they coincide?',
      'What does keeping only the top-k singular values do geometrically?',
      'How is rank related to singular values?',
    ],
    failureModes: [
      'Confusing U and V — V rotates the INPUT space, U rotates the OUTPUT space',
      'Thinking SVD and eigendecomposition are the same thing (they agree only for symmetric matrices)',
      'Forgetting singular values are always non-negative (unlike eigenvalues)',
    ],
    mvl: [
      { type: 'Watch', text: 'Steve Brunton — "SVD: Overview" + "Matrix Approximation"' },
      { type: 'Do', text: 'Image compression: reconstruct image with k=1,5,10,50 singular values' },
    ],
    projects: [
      { text: 'Image compression via SVD project' },
    ],
  },
  {
    id: 10, phase: 'p1', title: 'Dot Products, Orthogonality, and Projections',
    status: 'not-started', hours: '4–6h',
    prereqs: [5, 9],
    crossPhaseLinks: [37],
    conceptChecks: [
      'Give both the algebraic AND geometric formulas for the dot product. Why are they equal?',
      'What does a·b = 0 mean geometrically?',
      'What is the projection of u onto v, and why is the residual perpendicular to v?',
      'Why is cosine similarity better than raw dot product for comparing word embeddings?',
    ],
    failureModes: [
      'Confusing "orthogonal" (perpendicular, dot product = 0) with "orthonormal" (orthogonal AND unit length)',
      'Thinking the projection formula proj_v(u) = (u·v/v·v)v gives a scalar — it gives a VECTOR',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 9 — "Dot products and duality"' },
      { type: 'Do', text: 'Cosine similarity on GloVe/Word2Vec word pairs' },
    ],
    projects: [
      { text: 'Word embedding similarity explorer' },
    ],
  },
  {
    id: 11, phase: 'p1', title: 'Change of Basis, Norms, and Special Matrices',
    status: 'not-started', hours: '4–5h',
    prereqs: [8, 9, 10],
    crossPhaseLinks: [],
    conceptChecks: [
      'What does B⁻¹AB represent? Why is it the "same" transformation?',
      'Why does eigendecomposition A = PDP⁻¹ equal "view in eigenbasis, scale, view back"?',
      'Draw the unit balls for L1, L2, and L∞ norms. Why does L1 encourage sparsity?',
      'What does "positive definite" mean geometrically (think bowl shape)?',
    ],
    failureModes: [
      'Mixing up the direction of basis change: B⁻¹v converts TO the new basis, not from it',
      'Confusing norms: L1 (diamond), L2 (circle), L∞ (square) — draw them!',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B Ch. 13 — "Change of basis"' },
      { type: 'Do', text: 'Diagonalize A = PDP⁻¹ and verify; plot all three norm balls in 2D' },
    ],
    projects: [],
  },
  {
    id: 12, phase: 'p1', title: 'Linear Algebra Capstone',
    status: 'not-started', hours: '4–6h',
    prereqs: [10, 11],
    crossPhaseLinks: [],
    conceptChecks: [
      'For a given 3×3 matrix, explain rank, determinant, eigenvalues, SVD, and condition number geometrically.',
      'How does the neuron basis vs feature basis distinction relate to change of basis?',
      'Trace the path: vectors → transformations → rank → eigenvalues → SVD. How does each build on the last?',
    ],
    failureModes: [
      'Treating concepts as isolated — the capstone is about seeing them as ONE story',
      'Skipping the 3B1B full playlist re-watch. It hits differently after studying each piece.',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B full Essence of Linear Algebra playlist (re-watch)' },
      { type: 'Do', text: '30-minute comprehensive test + capstone visualization (SVD decomposition step by step)' },
    ],
    projects: [
      { text: 'Final capstone: SVD step-by-step visualization on unit circle' },
    ],
  },
  // ─── Phase 2: Calculus ───
  {
    id: 13, phase: 'p2', title: 'Matrix Calculus — Bridging to Backprop',
    status: 'not-started', hours: '3–5h',
    prereqs: [5],
    crossPhaseLinks: [12],
    conceptChecks: [
      'What is a partial derivative geometrically?',
      'What is the gradient vector and which direction does it point?',
      'What is the Jacobian and when do you need it (vs just a gradient)?',
    ],
    failureModes: [
      'Confusing the gradient (a vector) with the Jacobian (a matrix)',
      'Forgetting that the gradient points UPHILL — gradient DESCENT goes in the negative gradient direction',
    ],
    mvl: [
      { type: 'Read', text: '"The Matrix Calculus You Need for Deep Learning" by Parr & Howard' },
      { type: 'Do', text: 'Compute gradient of f(x,y) = x²y + sin(xy) by hand; verify numerically' },
    ],
    projects: [],
  },
  {
    id: 14, phase: 'p2', title: 'Partial Derivatives and Gradients — Going Deeper',
    status: 'not-started', hours: '3–4h',
    prereqs: [13],
    crossPhaseLinks: [],
    conceptChecks: [
      'Why is the gradient perpendicular to contour lines?',
      'What is a directional derivative and how does it relate to the gradient?',
      'If you walk in the gradient direction, are you going uphill or downhill?',
    ],
    failureModes: [
      'Thinking gradient descent finds the global minimum — it finds A minimum, not THE minimum',
      'Confusing contour lines (constant value) with gradient arrows (direction of steepest ascent)',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "Gradient descent, how neural networks learn" (DL Ch. 2)' },
      { type: 'Read', text: 'colah — "Calculus on Computational Graphs: Backpropagation"' },
    ],
    projects: [
      { text: 'Gradient field visualizer (2D contour plots with arrows)' },
    ],
  },
  {
    id: 15, phase: 'p2', title: 'The Chain Rule — This IS Backpropagation',
    status: 'not-started', hours: '4–6h',
    prereqs: [14],
    crossPhaseLinks: [],
    conceptChecks: [
      'Draw a computation graph for L = (wx+b-y)². Trace gradients backward through it.',
      'Why is reverse-mode autodiff (backprop) cheaper than forward-mode for neural networks?',
      'What is the chain rule in one sentence?',
    ],
    failureModes: [
      'Thinking backprop is a separate algorithm from the chain rule — it IS the chain rule on a computation graph',
      'Confusing the forward pass (compute values) with the backward pass (compute gradients)',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "Backpropagation, intuitively" (DL Ch. 3) + "Backpropagation calculus" (Ch. 4)' },
      { type: 'Do', text: 'Draw and manually trace backward through L = (wx+b-y)²' },
    ],
    projects: [],
  },
  {
    id: 16, phase: 'p2', title: 'Optimization and Gradient Descent',
    status: 'not-started', hours: '6–8h',
    prereqs: [15],
    crossPhaseLinks: [8],
    conceptChecks: [
      'What happens when the learning rate is too big? Too small?',
      'What does momentum do and why is it helpful?',
      'Why does Adam work better than vanilla SGD in practice?',
      'What does "convex" mean and why does it make optimization easy?',
    ],
    failureModes: [
      'Thinking SGD always converges — it depends on learning rate, landscape shape, and luck',
      'Confusing batch gradient descent (all data) with SGD (random mini-batches) with full-batch',
    ],
    mvl: [
      { type: 'Watch', text: 'Karpathy — "Building micrograd" (Lecture 1, ~2.5h)' },
      { type: 'Do', text: 'Complete micrograd: Value class with autodiff, train on simple 2D data' },
    ],
    projects: [
      { text: 'micrograd — autograd engine from scratch' },
    ],
  },
  {
    id: 17, phase: 'p2', title: 'Constrained Optimization and Lagrange Multipliers',
    status: 'not-started', hours: '3–5h',
    prereqs: [16],
    crossPhaseLinks: [],
    conceptChecks: [
      'What do Lagrange multipliers do geometrically? (Gradients are parallel at the optimum)',
      'What are KKT conditions and when do you need them?',
      'How is L2 regularization equivalent to a Lagrange constraint on weight magnitude?',
      'What is duality and why do SVMs use the dual formulation?',
    ],
    failureModes: [
      'Memorizing Lagrange multiplier formulas without the geometric insight (gradients must be parallel)',
      'Not seeing that alignment IS constrained optimization: maximize capability SUBJECT TO safety constraints',
    ],
    mvl: [
      { type: 'Watch', text: 'Khan Academy — "Lagrange multipliers, using tangency to solve constrained optimization"' },
      { type: 'Do', text: 'Solve a constrained optimization problem by hand; verify with code' },
    ],
    projects: [],
  },
  {
    id: 18, phase: 'p2', title: 'Loss Landscapes and Local Minima',
    status: 'not-started', hours: '3–4h',
    prereqs: [17],
    crossPhaseLinks: [8, 11],
    conceptChecks: [
      'Why are saddle points more common than local minima in high-dimensional spaces?',
      'What is the double descent phenomenon?',
      'What does the Hessian being positive definite at a point tell you?',
    ],
    failureModes: [
      'Assuming local minima are the main obstacle in neural network optimization — in high dimensions, saddle points dominate',
      'Confusing training loss (how well you fit data) with generalization (how well you perform on new data)',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "But what is a neural network?" (DL Ch. 1)' },
      { type: 'Read', text: 'colah — "Neural Networks, Manifolds, and Topology"' },
    ],
    projects: [
      { text: 'Add 2-parameter loss landscape visualization to micrograd project' },
    ],
  },
  // ─── Phase 3: Probability ───
  {
    id: 19, phase: 'p3', title: 'Probability Distributions and Bayes\' Theorem',
    status: 'not-started', hours: '4–5h',
    prereqs: [],
    crossPhaseLinks: [18],
    conceptChecks: [
      'What is the difference between a PDF and a PMF?',
      'State Bayes\' theorem and explain what prior, likelihood, and posterior mean.',
      'What distribution does a softmax output represent?',
    ],
    failureModes: [
      'Confusing P(A|B) with P(B|A) — the "prosecutor\'s fallacy"',
      'Thinking Bayesian and frequentist probability are incompatible rather than different frameworks',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "Bayes theorem, the geometry of changing beliefs"' },
      { type: 'Do', text: 'Implement Bayes\' theorem for a spam filter' },
    ],
    projects: [
      { text: 'Bayesian spam filter from scratch' },
    ],
  },
  {
    id: 20, phase: 'p3', title: 'Expectation, Variance, and Covariance',
    status: 'not-started', hours: '3–5h',
    prereqs: [19],
    crossPhaseLinks: [8, 9],
    conceptChecks: [
      'What is expected value geometrically (center of mass)?',
      'What does the covariance matrix being positive semi-definite mean?',
      'How is PCA related to eigendecomposition of the covariance matrix?',
    ],
    failureModes: [
      'Confusing covariance (can be any real number) with correlation (normalized to [-1,1])',
      'Forgetting that covariance matrices are always symmetric and PSD — connecting back to Lesson 10',
    ],
    mvl: [
      { type: 'Watch', text: 'StatQuest — "Covariance, Clearly Explained" + "PCA, Step by Step"' },
      { type: 'Do', text: 'Generate correlated 2D data, compute covariance matrix, find PCA directions' },
    ],
    projects: [
      { text: 'PCA from covariance eigenvectors (ties SVD ↔ statistics)' },
    ],
  },
  {
    id: 21, phase: 'p3', title: 'Maximum Likelihood Estimation',
    status: 'not-started', hours: '3–4h',
    prereqs: [19, 20],
    crossPhaseLinks: [16],
    conceptChecks: [
      'What does "maximum likelihood" mean in plain English?',
      'Why do we maximize log-likelihood instead of likelihood?',
      'How is minimizing cross-entropy loss the same as maximizing likelihood?',
    ],
    failureModes: [
      'Confusing likelihood (function of parameters given data) with probability (function of data given parameters)',
      'Missing the critical connection: LLM training objective = maximum likelihood estimation',
    ],
    mvl: [
      { type: 'Read', text: 'MML Book, Chapter 8.3' },
      { type: 'Do', text: 'MLE for a Gaussian: find best μ and σ from data' },
    ],
    projects: [],
  },
  {
    id: 22, phase: 'p3', title: 'Information Theory — Entropy, KL, Cross-Entropy, and Mutual Information',
    status: 'not-started', hours: '4–6h',
    prereqs: [21],
    crossPhaseLinks: [],
    conceptChecks: [
      'What does entropy measure? When is it maximized?',
      'What does KL divergence measure? Is it symmetric?',
      'Write the relationship: cross-entropy = entropy + KL divergence. What does this mean for training?',
      'What does temperature do in softmax?',
    ],
    failureModes: [
      'Thinking KL divergence is a distance metric — it\'s not symmetric! KL(P||Q) ≠ KL(Q||P)',
      'Confusing entropy (uncertainty of a distribution) with cross-entropy (using wrong distribution to encode)',
    ],
    mvl: [
      { type: 'Read', text: 'colah — "Visual Information Theory"' },
      { type: 'Do', text: 'Implement cross-entropy loss from scratch; show it decreases as model improves' },
    ],
    projects: [],
  },
  {
    id: 23, phase: 'p3', title: 'Bayesian Reasoning and Inference',
    status: 'not-started', hours: '5–7h',
    prereqs: [19, 21, 22],
    crossPhaseLinks: [11],
    conceptChecks: [
      'How is L2 regularization equivalent to a Gaussian prior on weights?',
      'What is the difference between MLE and MAP estimation?',
      'What is a likelihood ratio and why is it more intuitive than raw Bayes?',
      'What is Solomonoff induction and why is it uncomputable?',
    ],
    failureModes: [
      'Thinking Bayesian inference = just using Bayes\' theorem — it\'s a whole framework for reasoning under uncertainty',
      'Missing the stunning regularization = Bayesian prior connection (L2 = Gaussian prior, L1 = Laplace prior)',
    ],
    mvl: [
      { type: 'Read', text: 'Yudkowsky — "An Intuitive Explanation of Bayes\' Theorem"' },
      { type: 'Do', text: 'Sequential updating: coin bias posterior converging with more flips' },
    ],
    projects: [
      { text: 'Bayesian sequential updating visualizer' },
    ],
  },
  // ─── Phase 3b: Applied Statistics ───
  {
    id: 24, phase: 'p4', title: 'Hypothesis Testing, P-Values, and What They Actually Mean',
    status: 'not-started', hours: '3–5h',
    prereqs: [23],
    crossPhaseLinks: [],
    conceptChecks: [
      'What does a p-value actually mean? What does it NOT mean?',
      'What is the difference between statistical significance and practical significance?',
      'Why is multiple testing a problem and how do corrections work?',
    ],
    failureModes: [
      'Thinking p < 0.05 means "the result is true" — it means "this unlikely if H₀ were true"',
      'Confusing Type I and Type II errors',
    ],
    mvl: [
      { type: 'Read', text: 'ASA Statement on Statistical Significance and P-Values' },
      { type: 'Do', text: 'Simulate p-hacking: run many t-tests, see false positives accumulate' },
    ],
    projects: [],
  },
  {
    id: 25, phase: 'p4', title: 'Experimental Design and Common Statistical Fallacies',
    status: 'not-started', hours: '3–4h',
    prereqs: [24],
    crossPhaseLinks: [],
    conceptChecks: [
      'Why is random assignment important for causal claims?',
      'What is Simpson\'s paradox and why does it matter?',
      'How does sample size affect the reliability of conclusions?',
    ],
    failureModes: [
      'Assuming observational studies establish causation',
      'Ignoring confounders in natural experiments',
    ],
    mvl: [
      { type: 'Read', text: 'Examples of Simpson\'s paradox in real data' },
      { type: 'Do', text: 'Design an experiment to test a specific ML hypothesis' },
    ],
    projects: [],
  },
  {
    id: 26, phase: 'p4', title: 'Regression — From Linear to Logistic and Beyond',
    status: 'not-started', hours: '4–6h',
    prereqs: [24, 10],
    crossPhaseLinks: [],
    conceptChecks: [
      'How does linear regression connect to projection (Lesson 10)?',
      'What does logistic regression model and why is it used for classification?',
      'What is regularization doing in the Bayesian interpretation?',
    ],
    failureModes: [
      'Treating regression coefficients as causal effects without justification',
      'Applying linear regression to fundamentally nonlinear relationships',
    ],
    mvl: [
      { type: 'Do', text: 'Implement linear regression as projection: x̂ = (AᵀA)⁻¹Aᵀb' },
      { type: 'Do', text: 'Compare L1 vs L2 regularization on a real dataset' },
    ],
    projects: [],
  },
  {
    id: 27, phase: 'p4', title: 'Causal Inference — From Correlation to Causation',
    status: 'not-started', hours: '4–5h',
    prereqs: [25],
    crossPhaseLinks: [],
    conceptChecks: [
      'What is the difference between seeing and doing (Pearl\'s do-calculus)?',
      'What is a DAG and how does it represent causal assumptions?',
      'When can you infer causation from observational data?',
    ],
    failureModes: [
      'Assuming causal direction from correlation alone',
      'Ignoring unobserved confounders',
    ],
    mvl: [
      { type: 'Read', text: 'Pearl\'s "The Book of Why" — Chapters 1–3' },
      { type: 'Do', text: 'Draw causal DAGs for 3 real-world scenarios, identify confounders' },
    ],
    projects: [],
  },
  {
    id: 28, phase: 'p4', title: 'Applied Statistics — Genetics, Epidemiology, and Adjudicating Debates',
    status: 'not-started', hours: '3–4h',
    prereqs: [26, 27],
    crossPhaseLinks: [],
    conceptChecks: [
      'How do you evaluate competing statistical claims in a real controversy?',
      'What makes a meta-analysis stronger than individual studies?',
      'How does effect size complement p-values?',
    ],
    failureModes: [
      'Cherry-picking studies that support a conclusion',
      'Ignoring base rates when evaluating individual studies',
    ],
    mvl: [
      { type: 'Do', text: 'Analyze a real statistical controversy using the tools from this phase' },
    ],
    projects: [],
  },
  // ─── Phase 3c: Extended Mathematical Foundations ───
  {
    id: 29, phase: 'p5', title: 'Computability and Complexity — The Limits of Knowledge',
    status: 'not-started', hours: '4–6h',
    prereqs: [23],
    crossPhaseLinks: [],
    conceptChecks: [
      'Can you explain the halting problem proof (diagonal argument)?',
      'What does Rice\'s theorem say you CANNOT do about programs in general?',
      'What is Kolmogorov complexity and why is it uncomputable?',
      'Why is AIXI uncomputable? What does it have to do with Solomonoff induction?',
      'What is VC dimension and how does it relate to sample complexity?',
    ],
    failureModes: [
      'Thinking Rice\'s theorem means you can\'t verify ANYTHING — it\'s about GENERAL verifiers, not specific proofs',
      'Confusing computability (what\'s possible) with complexity (what\'s feasible)',
    ],
    mvl: [
      { type: 'Watch', text: 'Computerphile — "Halting Problem" and "Turing Machines Explained"' },
      { type: 'Read', text: 'Scott Aaronson — "Who Can Name the Bigger Number?"' },
      { type: 'Do', text: 'Rice\'s theorem application: list 5 alignment properties, explain why each is undecidable in general' },
    ],
    projects: [
      { text: 'Kolmogorov complexity estimation: shortest programs for 5 different strings' },
    ],
  },
  {
    id: 30, phase: 'p5', title: 'Abstract Algebra — Groups, Symmetry, and Neural Networks',
    status: 'not-started', hours: '4–6h',
    prereqs: [8, 9],
    crossPhaseLinks: [44],
    conceptChecks: [
      'What are the four axioms of a group? Give three concrete examples.',
      'Why does permuting hidden neurons give the same function? What group is this?',
      'What is the orbit-stabilizer theorem and why do singularities occur when stabilizers are large?',
      'How does weight space symmetry create the singularities that SLT studies?',
    ],
    failureModes: [
      'Thinking groups are purely abstract — they literally describe neural network symmetry',
      'Confusing the group (the symmetries) with the set being acted upon (the weight space)',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — groups and symmetry video' },
      { type: 'Read', text: '"Visual Group Theory" by Nathan Carter — Chapters 1-4' },
      { type: 'Do', text: 'Write out the multiplication table for S₃, find identity and inverses' },
      { type: 'Do', text: 'Demonstrate neuron permutation invariance in a PyTorch network' },
    ],
    projects: [
      { text: 'Orbit counting for networks with identical vs distinct neurons' },
    ],
  },
  {
    id: 31, phase: 'p5', title: 'Topology and Manifolds — The Shape of Data and Loss',
    status: 'not-started', hours: '4–6h',
    prereqs: [18],
    crossPhaseLinks: [44],
    conceptChecks: [
      'What is the manifold hypothesis and why does it explain deep learning\'s success?',
      'How does a ReLU layer divide space into flat regions?',
      'What is a homeomorphism? Why is topology \"geometry without measurement\"?',
      'What is resolution of singularities and why does SLT need it?',
    ],
    failureModes: [
      'Thinking topology is too abstract to be useful — the manifold hypothesis is concretely testable',
      'Confusing intrinsic dimension (of the manifold) with ambient dimension (of the embedding space)',
    ],
    mvl: [
      { type: 'Read', text: 'colah\'s blog — "Neural Networks, Manifolds, and Topology"' },
      { type: 'Do', text: 'Swiss roll: PCA fails, t-SNE succeeds — see the manifold structure' },
      { type: 'Do', text: 'Train a classifier on concentric circles, visualize layer-by-layer untangling' },
    ],
    projects: [
      { text: 'Intrinsic dimensionality estimation of MNIST / word embeddings' },
    ],
  },
  {
    id: 32, phase: 'p5', title: 'Differential Equations and Dynamical Systems — Training as Flow',
    status: 'not-started', hours: '4–5h',
    prereqs: [14, 16],
    crossPhaseLinks: [44],
    conceptChecks: [
      'What is gradient flow and how does it relate to gradient descent?',
      'What do eigenvalues of the Jacobian at a fixed point tell you about stability?',
      'How is a ResNet related to an Euler discretization of a neural ODE?',
      'What is a Lyapunov function and why is the loss function one for gradient flow?',
    ],
    failureModes: [
      'Thinking differential equations are irrelevant to discrete gradient descent — they\'re the continuous limit',
      'Confusing phase portraits (trajectories in state space) with loss landscape plots',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "Differential equations, a tourist\'s guide"' },
      { type: 'Do', text: 'Plot vector fields and solution trajectories for simple ODEs' },
      { type: 'Do', text: 'Gradient flow on a 2-parameter loss: trace trajectories to minima' },
    ],
    projects: [
      { text: 'Euler method instability: learning rate as step size' },
    ],
  },
  {
    id: 33, phase: 'p5', title: 'Formal Logic — Self-Reference, Incompleteness, and the Limits of Reason',
    status: 'not-started', hours: '4–5h',
    prereqs: [29],
    crossPhaseLinks: [],
    conceptChecks: [
      'State Gödel\'s first incompleteness theorem informally. What does it say can\'t be done?',
      'What is Löb\'s theorem and why does it obstruct AI self-trust?',
      'How does the diagonal argument appear in both the halting problem and Gödel\'s theorem?',
      'What is logical uncertainty and why is it different from empirical uncertainty?',
    ],
    failureModes: [
      'Thinking incompleteness means math is broken — it means formal systems have inherent limits',
      'Over-applying Gödel (it applies to formal systems strong enough for arithmetic, not to everything)',
    ],
    mvl: [
      { type: 'Watch', text: 'Veritasium — "Math Has a Fatal Flaw"' },
      { type: 'Read', text: '"Gödel\'s Proof" by Nagel & Newman (100 pages, very clear)' },
      { type: 'Do', text: 'Write a Python quine — self-reference made concrete' },
    ],
    projects: [
      { text: 'Löb\'s theorem thought exercise: why can\'t an AI prove its own alignment?' },
    ],
  },
  // ─── Phase 4: Neural Networks ───
  {
    id: 34, phase: 'p6', title: 'How a Single Neuron Works',
    status: 'not-started', hours: '3–4h',
    prereqs: [10],
    crossPhaseLinks: [15, 16],
    conceptChecks: [
      'What are the three steps a single neuron computes?',
      'Why can\'t a single neuron learn XOR?',
      'Why did ReLU largely replace sigmoid/tanh?',
      'What is the universal approximation theorem? What doesn\'t it tell you?',
    ],
    failureModes: [
      'Thinking "universal approximation" means any network can learn anything — it says nothing about LEARNING, only representation',
      'Forgetting that a neuron IS a dot product + nonlinearity — you already know both pieces from Lessons 9 + calculus',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "But what is a neural network?" (DL Ch. 1)' },
      { type: 'Do', text: 'Implement a single neuron, train on AND/OR/XOR, discover XOR fails' },
    ],
    projects: [
      { text: 'Single neuron trainer (AND, OR, XOR discovery)' },
    ],
  },
  {
    id: 35, phase: 'p6', title: 'The Forward Pass as Matrix Multiplications',
    status: 'not-started', hours: '6–8h',
    prereqs: [34],
    crossPhaseLinks: [4, 5, 6],
    conceptChecks: [
      'How is a layer of neurons the same as a matrix multiplication?',
      'What does the forward pass f₃(f₂(f₁(x))) look like in terms of matrices?',
      'What does softmax do and why do we need it?',
    ],
    failureModes: [
      'Losing the connection to linear algebra: each layer IS Lesson 4 (a linear transformation) + a nonlinearity',
      'Thinking each neuron is independent — they share inputs, and the matrix captures ALL neurons in a layer simultaneously',
    ],
    mvl: [
      { type: 'Watch', text: 'Karpathy — "Building makemore" (Lecture 2)' },
      { type: 'Do', text: 'Implement 2-layer MLP from scratch in NumPy, train on MNIST' },
    ],
    projects: [
      { text: 'Build MLP on top of micrograd engine; train on MNIST' },
    ],
  },
  {
    id: 36, phase: 'p6', title: 'Backpropagation Through the Full Network',
    status: 'not-started', hours: '6–8h',
    prereqs: [35],
    crossPhaseLinks: [15, 16],
    conceptChecks: [
      'Why do vanishing gradients happen? How do residual connections fix them?',
      'What does batch normalization do to activations?',
      'Why does weight initialization matter?',
    ],
    failureModes: [
      'Thinking residual connections are optional tricks — they are THE reason deep networks work, and THE backbone of transformers',
      'Not doing the backprop ninja exercise manually — mechanical understanding of gradient flow is irreplaceable',
    ],
    mvl: [
      { type: 'Watch', text: 'Karpathy — "Becoming a Backprop Ninja" (Lecture 5)' },
      { type: 'Do', text: 'Manually backprop through cross-entropy → linear → tanh → batchnorm' },
    ],
    projects: [
      { text: 'Add residual connections + batchnorm to MLP' },
    ],
  },
  {
    id: 37, phase: 'p6', title: 'Attention — Dot Products in Action',
    status: 'not-started', hours: '5–7h',
    prereqs: [36],
    crossPhaseLinks: [6, 10],
    conceptChecks: [
      'What are Q, K, V and where do they come from?',
      'Why is the attention score a dot product? What does it measure?',
      'What is the difference between attention scores (pre-softmax) and attention weights (post-softmax)?',
      'What do the QK and OV circuits compute?',
    ],
    failureModes: [
      'Confusing attention scores (raw dot products) with attention weights (after softmax) — this matters for interpretability',
      'Thinking each head does the same thing — different heads learn different patterns (syntax, coreference, etc.)',
    ],
    mvl: [
      { type: 'Watch', text: '3B1B — "Attention in transformers, step-by-step" (DL Ch. 6)' },
      { type: 'Do', text: 'Implement single-head attention from scratch in NumPy, visualize attention matrix' },
    ],
    projects: [
      { text: 'Attention mechanism from scratch + heatmap visualization' },
    ],
  },
  {
    id: 38, phase: 'p6', title: 'Building a Transformer from Scratch',
    status: 'not-started', hours: '10–15h',
    prereqs: [37],
    crossPhaseLinks: [11, 22],
    conceptChecks: [
      'What is the residual stream and why is it the backbone of the transformer?',
      'What does causal masking do and why is it necessary for language modeling?',
      'What is the full transformer block? (attention → add&norm → MLP → add&norm)',
      'How does positional encoding give the model a sense of order?',
    ],
    failureModes: [
      'Not typing every line of Karpathy\'s GPT build — watching is not the same as doing',
      'Missing that the residual stream IS the central communication channel for all interpretability work',
    ],
    mvl: [
      { type: 'Watch', text: 'Karpathy — "Let\'s build GPT" (Lecture 7, ~2h)' },
      { type: 'Do', text: 'Build a working GPT from scratch, generate text' },
    ],
    projects: [
      { text: 'Full GPT build — the culminating coding project' },
    ],
  },
  {
    id: 39, phase: 'p6', title: 'Reinforcement Learning Foundations',
    status: 'not-started', hours: '5–7h',
    prereqs: [38],
    crossPhaseLinks: [16, 22],
    conceptChecks: [
      'What are the components of an MDP (states, actions, rewards, transitions)?',
      'What does a policy gradient update do intuitively?',
      'Why does PPO clip the update? What goes wrong without it?',
      'Walk through the RLHF pipeline: what happens at each of the 4 stages?',
    ],
    failureModes: [
      'Trying to learn all of RL — you only need MDPs, policy gradients, PPO, and reward hacking for alignment',
      'Not connecting RL to the math: policy gradient = gradient ascent (L15), KL penalty = constrained optimization (L15b)',
    ],
    mvl: [
      { type: 'Watch', text: 'Karpathy — "Deep Dive into LLMs like ChatGPT" (RLHF section)' },
      { type: 'Read', text: 'Hugging Face — "Illustrating RLHF"' },
    ],
    projects: [
      { text: 'GridWorld policy gradient + reward hacking demo' },
    ],
  },
  {
    id: 40, phase: 'p6', title: 'The LLM Training Pipeline',
    status: 'not-started', hours: '4–6h',
    prereqs: [39],
    crossPhaseLinks: [21, 23],
    conceptChecks: [
      'Name the 4 stages of the LLM pipeline and what each one optimizes.',
      'What math from your curriculum appears at each stage?',
      'Why does SFT alone not produce an aligned model?',
      'What are the alignment failure points at each stage?',
    ],
    failureModes: [
      'Thinking RLHF "solves" alignment — it reduces one type of misalignment but introduces others (reward hacking, sycophancy)',
      'Not watching Karpathy\'s full Deep Dive — it\'s the single best resource for this lesson',
    ],
    mvl: [
      { type: 'Watch', text: 'Karpathy — "Deep Dive into LLMs" (full ~3.5h)' },
      { type: 'Do', text: 'For each pipeline stage, write which curriculum lesson covers the math' },
    ],
    projects: [],
  },
  // ─── Phase 5: Interpretability ───
  {
    id: 41, phase: 'p7', title: 'What Interpretability Researchers Actually Do',
    status: 'not-started', hours: '6–8h',
    prereqs: [40],
    crossPhaseLinks: [3, 6, 10, 11],
    conceptChecks: [
      'What is the superposition hypothesis?',
      'What is the difference between a feature and a neuron?',
      'Name four key mechanistic interpretability techniques.',
      'What does a sparse autoencoder do?',
    ],
    failureModes: [
      'Thinking neurons = features. The entire point of modern interp is that they\'re NOT the same.',
      'Starting interp work without strong linear algebra — you cannot read these papers without Lessons 1–11.',
    ],
    mvl: [
      { type: 'Read', text: '"A Mathematical Framework for Transformer Circuits" (Elhage et al.)' },
      { type: 'Do', text: 'Install TransformerLens, load GPT-2, extract and visualize attention patterns' },
    ],
    projects: [
      { text: 'TransformerLens setup + GPT-2 attention visualization' },
    ],
  },
  {
    id: 42, phase: 'p7', title: 'Circuits and Features in Practice',
    status: 'not-started', hours: '8–12h',
    prereqs: [41],
    crossPhaseLinks: [9],
    conceptChecks: [
      'What is an induction head and what does it do?',
      'What is the residual stream in terms of how components read and write?',
      'How does a sparse autoencoder decompose activations into features?',
      'What did "Scaling Monosemanticity" find?',
    ],
    failureModes: [
      'Trying to replicate induction heads without first understanding 2-layer attention mechanics (read the Circuits paper first)',
      'Getting lost in code without understanding the linear algebra of what activation patching does',
    ],
    mvl: [
      { type: 'Read', text: '"In-context Learning and Induction Heads" (Olsson et al.)' },
      { type: 'Do (scaffolded)', text: '1) Load 2-layer model in TransformerLens. 2) Identify induction heads by attention pattern. 3) Run activation patching on a simple copying task. 4) Then try full replication.' },
    ],
    projects: [
      { text: 'Induction head finding + activation patching in TransformerLens' },
    ],
  },
  {
    id: 43, phase: 'p7', title: 'Scaling Laws, Emergent Capabilities, and Phase Transitions',
    status: 'not-started', hours: '5–7h',
    prereqs: [42],
    crossPhaseLinks: [18],
    conceptChecks: [
      'What is a scaling law and what three variables does it relate?',
      'What did the Chinchilla paper change about how labs train models?',
      'Are emergent capabilities real or a measurement artifact? Explain both sides.',
      'Why does the "bitter lesson" worry alignment researchers?',
    ],
    failureModes: [
      'Assuming smooth scaling means smooth capability improvement — practical usefulness can have sharp thresholds',
      'Taking the bitter lesson as gospel — clever methods AND scale both matter',
    ],
    mvl: [
      { type: 'Read', text: 'Kaplan et al. — "Scaling Laws for Neural Language Models"' },
      { type: 'Read', text: 'Rich Sutton — "The Bitter Lesson" (1 page)' },
    ],
    projects: [
      { text: 'Plot scaling laws from published benchmarks (log-log)' },
    ],
  },
  {
    id: 44, phase: 'p7', title: 'Singular Learning Theory — The Geometry of Learning',
    status: 'not-started', hours: '5–8h',
    prereqs: [43],
    crossPhaseLinks: [8, 18],
    conceptChecks: [
      'Why do standard statistics (AIC, BIC) give wrong answers for neural networks?',
      'What is the RLCT and how does it replace parameter count as a complexity measure?',
      'What does "singular" mean in the context of the loss landscape?',
      'How do phase transitions during training connect to changes in the RLCT?',
    ],
    failureModes: [
      'Thinking you need full algebraic geometry — the conceptual framework is accessible with eigenvalues and Hessians you already know',
      'Getting intimidated by the math — focus on geometric intuition: singularities = flat directions = symmetries = lower effective complexity',
    ],
    mvl: [
      { type: 'Read', text: 'Jesse Hoogland — "Neural Networks are Singular" (LessWrong)' },
      { type: 'Do', text: 'Plot f(w₁,w₂) = (w₁w₂)². See the cross-shaped valley. Compute the Hessian at origin — it\'s zero.' },
    ],
    projects: [
      { text: 'Singularity visualization + parameter symmetry demo' },
    ],
  },
  // ─── Phase 6: Alignment Theory ───
  {
    id: 45, phase: 'p8', title: 'Game Theory Foundations',
    status: 'not-started', hours: '6–8h',
    prereqs: [],
    crossPhaseLinks: [5],
    conceptChecks: [
      'What is a Nash equilibrium? Is it always the best outcome?',
      'In the Prisoner\'s Dilemma, why is mutual defection the Nash equilibrium despite mutual cooperation being better?',
      'What is mechanism design and how does it relate to designing reward functions?',
      'Model the AI safety race as a payoff matrix. What\'s the equilibrium?',
    ],
    failureModes: [
      'Thinking Nash equilibrium means "optimal" — it means stable, which can be terrible (mutual defection)',
      'Treating game theory as pure philosophy — the payoff matrices ARE systems of equations from linear algebra',
    ],
    mvl: [
      { type: 'Watch', text: 'Yale Game Theory Course (Ben Polak) — Lectures 1–3' },
      { type: 'Read', text: 'Scott Alexander — "Meditations on Moloch"' },
    ],
    projects: [
      { text: 'Prisoner\'s Dilemma tournament simulator (tit-for-tat etc.)' },
    ],
  },
  {
    id: 46, phase: 'p8', title: 'Decision Theory — CDT, EDT, and FDT',
    status: 'not-started', hours: '5–7h',
    prereqs: [45],
    crossPhaseLinks: [19, 23],
    conceptChecks: [
      'Explain CDT, EDT, and FDT each in one sentence.',
      'What does each decision theory say about Newcomb\'s Problem? Why?',
      'Why might FDT be the right decision theory for aligned AI?',
      'What is reflective stability and why does CDT fail it?',
    ],
    failureModes: [
      'Treating decision theory as armchair philosophy — it determines how an AI actually makes choices',
      'Not computing expected utilities numerically for each thought experiment — do the math, don\'t just argue verbally',
    ],
    mvl: [
      { type: 'Watch', text: 'Robert Miles — "Newcomb\'s Problem"' },
      { type: 'Read', text: 'Yudkowsky & Soares — "Functional Decision Theory" (2018)' },
    ],
    projects: [
      { text: 'Add Newcomb simulator + DT comparison to game theory project' },
    ],
  },
  {
    id: 47, phase: 'p8', title: 'Anthropics and Self-Locating Beliefs',
    status: 'not-started', hours: '4–6h',
    prereqs: [46],
    crossPhaseLinks: [19, 23],
    conceptChecks: [
      'What is the Sleeping Beauty problem? What do thirders and halfers believe, and why?',
      'State Bostrom\'s Simulation Argument\'s three propositions.',
      'How does anthropic reasoning connect to deceptive alignment?',
      'What is SSA vs SIA?',
    ],
    failureModes: [
      'Confusing Anthropic (the company) with anthropics (the philosophical discipline)',
      'Taking the Doomsday Argument too literally — it illustrates a reasoning pattern, not a firm prediction',
    ],
    mvl: [
      { type: 'Watch', text: 'Numberphile — "Sleeping Beauty Paradox"' },
      { type: 'Do', text: 'Sleeping Beauty simulator: run 10,000 trials from both perspectives' },
    ],
    projects: [
      { text: 'Sleeping Beauty + Doomsday Argument simulators' },
    ],
  },
  {
    id: 48, phase: 'p8', title: 'The Alignment Problem — Technical Foundations',
    status: 'not-started', hours: '6–8h',
    prereqs: [45, 46, 47],
    crossPhaseLinks: [41, 42, 16, 22],
    conceptChecks: [
      'What is the difference between outer alignment and inner alignment?',
      'What is a mesa-optimizer and why is it dangerous?',
      'Explain deceptive alignment in two sentences.',
      'What are the theoretical limitations of RLHF?',
    ],
    failureModes: [
      'Thinking alignment is "just make the reward function right" — that\'s outer alignment only; inner alignment is the harder problem',
      'Not connecting mesa-optimization to everything you learned about training dynamics (loss landscapes, optimization)',
    ],
    mvl: [
      { type: 'Read', text: '"Risks from Learned Optimization" (Hubinger et al., 2019)' },
      { type: 'Read', text: '"Concrete Problems in AI Safety" (Amodei et al., 2016)' },
    ],
    projects: [],
  },
  {
    id: 49, phase: 'p8', title: 'Open Problems and Research Frontiers',
    status: 'not-started', hours: '4–6h',
    prereqs: [48],
    crossPhaseLinks: [41, 42, 8],
    conceptChecks: [
      'What is scalable oversight and why is it hard?',
      'What is ELK (Eliciting Latent Knowledge)?',
      'What does Singular Learning Theory study?',
      'Name three open problems in mechanistic interpretability.',
    ],
    failureModes: [
      'Getting overwhelmed by the number of open problems — pick ONE that excites you and go deep',
      'Skipping empirical work in favor of only reading theory — alignment needs both',
    ],
    mvl: [
      { type: 'Read', text: 'Neel Nanda — "200 Concrete Open Problems in Mechanistic Interpretability"' },
      { type: 'Do', text: 'Pick one open problem. Write a 1-page plan for how you\'d approach it.' },
    ],
    projects: [],
  },
];

// Review checkpoints
const CHECKPOINTS = [
  {
    id: 'cp1', afterLesson: 12, phase: 'p1', title: 'Phase 1 Review: LA → ML Bridge',
    exercises: [
      '<strong>Matrix decomposition relay:</strong> Take a 4×4 matrix. Compute rank, determinant, eigenvalues, SVD. For each, state one thing an ML researcher would care about.',
      '<strong>Attention from scratch:</strong> Using ONLY linear algebra (no neural network framing), compute Q·Kᵀ for two 3-dimensional query and key vectors. Explain what the resulting scalar means geometrically.',
      '<strong>Superposition puzzle:</strong> You have 5 features to represent in 3 dimensions. Show that you can\'t make all pairs orthogonal. Find an arrangement that minimizes maximum dot product between any pair.',
    ],
  },
  {
    id: 'cp2', afterLesson: 18, phase: 'p2', title: 'Phase 2 Review: Calculus → Training Bridge',
    exercises: [
      '<strong>Full backprop trace:</strong> Given a 2-layer MLP with specific weights, compute the forward pass AND backward pass by hand for one data point. Verify your gradients numerically.',
      '<strong>Loss landscape connection:</strong> Create a 2-parameter loss function. Visualize gradient descent with different learning rates. Connect to eigenvalues of the Hessian.',
      '<strong>Chain rule to circuits:</strong> Draw the computation graph for attention (QK dot product → softmax → weighted sum of V). Label every edge with what gradient flows through it.',
    ],
  },
  {
    id: 'cp3', afterLesson: 33, phase: 'p3', title: 'Phase 3 Review: Probability + Math Foundations → LLM Training Bridge',
    exercises: [
      '<strong>Full training loop explained:</strong> Starting from MLE, derive why cross-entropy is the loss function for next-token prediction. Connect entropy, KL divergence, and the training objective.',
      '<strong>Regularization unification:</strong> Show that L2 weight decay = Gaussian prior = MAP estimation. Compute the MAP estimate for a simple 1-parameter model.',
      '<strong>Covariance → PCA → SVD:</strong> Generate 3D data with structure. Compute covariance matrix, find eigenvectors (PCA), compare with SVD of the centered data matrix. Show they give the same principal directions.',
    ],
  },
  {
    id: 'cp4', afterLesson: 40, phase: 'p6', title: 'Phase 4 Review: Everything → Transformer Bridge',
    exercises: [
      '<strong>Mathematical audit:</strong> Open your GPT code. For every matrix multiplication, state: the input/output dimensions, the rank of the weight matrix, what information bottleneck it creates.',
      '<strong>Attention as projection:</strong> Show that attention is a form of weighted projection. Connect attention weights → linear combinations (Lesson 3) → projections (Lesson 10).',
      '<strong>End-to-end pipeline:</strong> Trace a model from pre-training (MLE, cross-entropy) through SFT (distribution shift) to RLHF (policy gradient + KL penalty). For each stage, name the math concepts and which lesson covers them.',
    ],
  },
  {
    id: 'cp5', afterLesson: 44, phase: 'p7', title: 'Phase 5 Review: Interp → Alignment Bridge',
    exercises: [
      '<strong>Feature geometry:</strong> In TransformerLens, extract residual stream activations for 100 inputs. Run PCA. Interpret the top 3 components. Connect to eigenvectors (Lesson 8) and change of basis (Lesson 11).',
      '<strong>Superposition quantification:</strong> For a set of feature directions found by an SAE, compute pairwise cosine similarities. Visualize as a heatmap. How orthogonal are they?',
      '<strong>Scaling + SLT connection:</strong> How would you use the Local Learning Coefficient (LLC) to detect when a model acquires a new capability during training? What would a phase transition look like in an LLC plot?',
    ],
  },
  {
    id: 'cp6', afterLesson: 49, phase: 'p8', title: 'Phase 6 Review: Full Integration',
    exercises: [
      '<strong>Alignment scenario analysis:</strong> A model trained with RLHF shows unexpected behavior in deployment. Using game theory (what strategies are at play?), decision theory (what decision procedure is the model using?), Bayesian reasoning (what\'s your posterior that it\'s deceptive?), and interpretability (what would you look for internally?) — write a full analysis.',
      '<strong>Mathematical connections map:</strong> Create a concept map connecting at least 15 specific concepts from across all 6 phases. Each connection should be a concrete statement, not just "related to."',
    ],
  },
];

const LAYOUT = {
  width: 1200,
  height: 1000,
  nodes: {
    // Phase 0 - setup
    0:  { x: 80,  y: 30 },
    // Phase 1 - left area
    1:  { x: 80,  y: 110 },
    2:  { x: 80,  y: 190 },
    3:  { x: 80,  y: 280 },
    4:  { x: 190, y: 280 },
    5:  { x: 135, y: 370 },
    6:  { x: 30,  y: 370 },
    7:  { x: 80,  y: 460 },
    8:  { x: 80,  y: 550 },
    9:  { x: 200, y: 550 },
    10: { x: 140, y: 640 },
    11: { x: 80,  y: 730 },
    // Phase 2 - center-left
    12: { x: 340, y: 280 },
    13: { x: 340, y: 370 },
    14: { x: 340, y: 460 },
    15: { x: 340, y: 560 },
    1501: { x: 340, y: 650 },
    16: { x: 340, y: 740 },
    // Phase 3 - center
    17: { x: 530, y: 110 },
    18: { x: 530, y: 210 },
    19: { x: 530, y: 310 },
    20: { x: 530, y: 410 },
    21: { x: 530, y: 520 },
    // Phase 4 - center-right
    22: { x: 720, y: 210 },
    23: { x: 720, y: 310 },
    24: { x: 720, y: 410 },
    25: { x: 720, y: 510 },
    26: { x: 720, y: 610 },
    2601: { x: 720, y: 720 },
    2602: { x: 720, y: 830 },
    // Phase 5 - right
    27: { x: 910, y: 460 },
    28: { x: 910, y: 570 },
    2801: { x: 910, y: 690 },
    2802: { x: 910, y: 810 },
    // Phase 6 - far right
    29: { x: 1060, y: 100 },
    30: { x: 1120, y: 220 },
    31: { x: 1120, y: 340 },
    32: { x: 1080, y: 460 },
    33: { x: 1080, y: 580 },
  },
};


// ═══════════════════════════════════════════════
// CALENDAR STATE
// ═══════════════════════════════════════════════

const CALENDAR_KEY = 'alignment-curriculum-calendar';
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth();
let calSelectedDate = null;
let calDragLesson = null;

function loadCalendar() {
  try { return JSON.parse(localStorage.getItem(CALENDAR_KEY)) || {}; } catch(e) { return {}; }
}
function saveCalendar(cal) { localStorage.setItem(CALENDAR_KEY, JSON.stringify(cal)); }
function dateKey(y, m, d) { return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }

function getScheduledDayCounts() {
  const cal = loadCalendar();
  const counts = {};
  Object.values(cal).forEach(ids => ids.forEach(id => { counts[id] = (counts[id] || 0) + 1; }));
  return counts;
}


// ═══════════════════════════════════════════════
// RENDERING ENGINE
// ═══════════════════════════════════════════════

let currentView = 'dependency';
let selectedLesson = null;

const STATUS_KEY = 'alignment-curriculum-statuses';
const STATUS_CYCLE = ['not-started', 'in-progress', 'complete'];

function loadStatuses() {
  try {
    const saved = JSON.parse(localStorage.getItem(STATUS_KEY));
    if (saved) LESSONS.forEach(l => { if (saved[l.id] !== undefined) l.status = saved[l.id]; });
  } catch(e) {}
}

function saveStatuses() {
  const obj = {};
  LESSONS.forEach(l => obj[l.id] = l.status);
  localStorage.setItem(STATUS_KEY, JSON.stringify(obj));
}

function cycleStatus(id, ev) {
  if (ev) ev.stopPropagation();
  const lesson = LESSONS.find(l => l.id === id);
  const idx = STATUS_CYCLE.indexOf(lesson.status);
  lesson.status = STATUS_CYCLE[(idx + 1) % 3];
  saveStatuses();
  refreshAll();
  if (selectedLesson === id) selectLesson(id);
}

function updateStats() {
  const total = LESSONS.length;
  const complete = LESSONS.filter(l => l.status === 'complete').length;
  const inProgress = LESSONS.filter(l => l.status === 'in-progress').length;
  document.getElementById('stat-complete').textContent = complete;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('progress-fill').style.width = `${(complete / total) * 100}%`;

  function parseHours(h) {
    const m = h.match(/(\d+)–(\d+)/);
    return m ? (parseInt(m[2]) + parseInt(m[3])) / 2 : 5;
  }
  let done = 0, remaining = 0;
  LESSONS.forEach(l => {
    const h = parseHours(l.hours);
    if (l.status === 'complete') done += h;
    else remaining += h;
  });
  document.getElementById('stat-hours-done').textContent = Math.round(done);
  document.getElementById('stat-hours-left').textContent = Math.round(remaining);
}

function refreshAll() {
  renderSidebar();
  if (currentView === 'dependency') renderGraph();
  else if (currentView === 'timeline') renderTimeline();
  else if (currentView === 'calendar') renderCalendar();
  updateStats();
}

function getPhaseColor(phaseId) {
  const p = PHASES.find(ph => ph.id === phaseId);
  return p ? p.color : '#888';
}

function getStatusColor(status) {
  if (status === 'complete') return 'var(--complete)';
  if (status === 'in-progress') return 'var(--in-progress)';
  return 'var(--not-started)';
}

// ── Sidebar ──
function renderSidebar() {
  const sidebar = document.getElementById('sidebar');
  let html = '';
  PHASES.forEach(phase => {
    const phaseLessons = LESSONS.filter(l => l.phase === phase.id);
    html += `<div class="nav-section-header" onclick="toggleSection('${phase.id}')" style="color:${phase.color}">
      <span class="chevron" id="chev-${phase.id}">▾</span> ${phase.name.toUpperCase()}
    </div>`;
    html += `<div id="section-${phase.id}">`;
    phaseLessons.forEach(lesson => {
      html += `<div class="nav-item" id="nav-item-${lesson.id}" onclick="selectLesson(${lesson.id})">
        <div class="status-dot" style="background:${getStatusColor(lesson.status)}" onclick="cycleStatus(${lesson.id}, event)" title="Click to cycle status"></div>
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;opacity:0.5;width:22px">${lesson.label || lesson.id}</span>
        ${lesson.title}
      </div>`;
    });
    // Checkpoint
    const cp = CHECKPOINTS.find(c => c.phase === phase.id);
    if (cp) {
      html += `<div class="nav-item-checkpoint" onclick="selectCheckpoint('${cp.id}')">✎ ${cp.title}</div>`;
    }
    html += `</div>`;
  });
  sidebar.innerHTML = html;
}

function toggleSection(phaseId) {
  const section = document.getElementById(`section-${phaseId}`);
  const chev = document.getElementById(`chev-${phaseId}`);
  const hidden = section.style.display === 'none';
  section.style.display = hidden ? '' : 'none';
  chev.classList.toggle('collapsed', !hidden);
}

// ── Dependency Map ──
function renderGraph() {
  const svg = document.getElementById('graph-svg');
  const rect = svg.parentElement.getBoundingClientRect();
  const w = rect.width;
  const h = rect.height;

  const scaleX = w / LAYOUT.width;
  const scaleY = h / LAYOUT.height;
  const scale = Math.min(scaleX, scaleY) * 0.88;
  const offsetX = (w - LAYOUT.width * scale) / 2 + 20;
  const offsetY = (h - LAYOUT.height * scale) / 2 + 10;

  function tx(x) { return x * scale + offsetX; }
  function ty(y) { return y * scale + offsetY; }

  let edgesHtml = '';
  let nodesHtml = '';

  LESSONS.forEach(lesson => {
    const to = LAYOUT.nodes[lesson.id];
    lesson.prereqs.forEach(prereqId => {
      const from = LAYOUT.nodes[prereqId];
      edgesHtml += `<line class="edge" id="edge-${prereqId}-${lesson.id}" x1="${tx(from.x)}" y1="${ty(from.y)}" x2="${tx(to.x)}" y2="${ty(to.y)}" />`;
    });
    lesson.crossPhaseLinks.forEach(linkId => {
      const from = LAYOUT.nodes[linkId];
      if (from) {
        edgesHtml += `<line class="edge edge-cross-phase" id="xedge-${linkId}-${lesson.id}" x1="${tx(from.x)}" y1="${ty(from.y)}" x2="${tx(to.x)}" y2="${ty(to.y)}" />`;
      }
    });
  });

  LESSONS.forEach(lesson => {
    const pos = LAYOUT.nodes[lesson.id];
    const color = getPhaseColor(lesson.phase);
    const r = 18;
    const statusColor = getStatusColor(lesson.status);
    const fillOpacity = lesson.status === 'complete' ? 0.25 : lesson.status === 'in-progress' ? 0.15 : 0.08;

    nodesHtml += `<g class="node-group" onclick="selectLesson(${lesson.id})" id="node-${lesson.id}">
      <circle class="node-circle" cx="${tx(pos.x)}" cy="${ty(pos.y)}" r="${r}" fill="${color}" fill-opacity="${fillOpacity}" stroke="${statusColor}" />
      <text class="node-number" x="${tx(pos.x)}" y="${ty(pos.y) + 4}" fill="${lesson.status === 'not-started' ? color : statusColor}">${lesson.label || lesson.id}</text>
    </g>`;
  });

  const phaseLabels = [
    { x: 30, y: 12, color: '#94a3b8' },
    { x: 80, y: 60, color: '#6ee7b7' },
    { x: 340, y: 230, color: '#818cf8' },
    { x: 530, y: 60, color: '#f9a8d4' },
    { x: 720, y: 155, color: '#fbbf24' },
    { x: 910, y: 410, color: '#38bdf8' },
    { x: 1080, y: 50, color: '#c084fc' },
  ];

  let labelsHtml = '';
  phaseLabels.forEach(pl => {
    labelsHtml += `<text x="${tx(pl.x)}" y="${ty(pl.y)}" fill="${pl.color}" opacity="0.3" font-family="JetBrains Mono, monospace" font-size="10" font-weight="700" letter-spacing="2" text-anchor="middle">${pl.label}</text>`;
  });

  svg.innerHTML = labelsHtml + edgesHtml + nodesHtml;
}

// ── Select Lesson ──
function selectLesson(id) {
  selectedLesson = id;
  const lesson = LESSONS.find(l => l.id === id);
  if (!lesson) return;

  // Sidebar highlight
  document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
  const navItem = document.getElementById(`nav-item-${id}`);
  if (navItem) navItem.classList.add('active');

  // Edge highlighting (only in dependency view)
  if (currentView === 'dependency') {
    document.querySelectorAll('.edge').forEach(el => el.classList.remove('highlighted'));
    lesson.prereqs.forEach(pid => {
      const edge = document.getElementById(`edge-${pid}-${id}`);
      if (edge) edge.classList.add('highlighted');
    });
    lesson.crossPhaseLinks.forEach(lid => {
      const edge = document.getElementById(`xedge-${lid}-${id}`);
      if (edge) edge.classList.add('highlighted');
    });
    LESSONS.forEach(other => {
      if (other.prereqs.includes(id)) {
        const edge = document.getElementById(`edge-${id}-${other.id}`);
        if (edge) edge.classList.add('highlighted');
      }
    });
  }

  // Build detail panel
  const phase = PHASES.find(p => p.id === lesson.phase);
  let html = '';

  html += `<div class="detail-header">
    <div class="detail-phase-tag" style="color:${phase.color}">
      <div style="background:${phase.color};width:6px;height:6px;border-radius:50%"></div>
      Phase ${phase.id.replace('p','')} · ${phase.name}
    </div>
    <div class="detail-title">Lesson ${lesson.label || lesson.id}: ${lesson.title}</div>
    <div class="detail-meta">
      <div>⏱ <strong>${lesson.hours}</strong></div>
      <div>Status: <strong style="color:${getStatusColor(lesson.status)};cursor:pointer;border-bottom:1px dashed" onclick="cycleStatus(${lesson.id}, event)" title="Click to change">${lesson.status.replace('-', ' ')}</strong></div>
    </div>
  </div>`;

  // Prerequisites
  html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">⬆</span> Prerequisites</div>`;
  if (lesson.prereqs.length === 0 && lesson.crossPhaseLinks.length === 0) {
    html += `<p style="font-size:13px;color:var(--text-dim)">None — entry point</p>`;
  } else {
    html += `<ul class="prereq-list">`;
    lesson.prereqs.forEach(pid => {
      const p = LESSONS.find(l => l.id === pid);
      html += `<li><span class="prereq-link" onclick="selectLesson(${pid})">Lesson ${p.label || pid}</span>: ${p.title} <span style="color:${getStatusColor(p.status)};font-size:11px">(${p.status.replace('-',' ')})</span></li>`;
    });
    lesson.crossPhaseLinks.forEach(lid => {
      const l = LESSONS.find(ls => ls.id === lid);
      if (l) {
        html += `<li style="opacity:0.7"><span class="prereq-link" onclick="selectLesson(${lid})">Lesson ${l.label || lid}</span>: ${l.title} <span style="font-size:11px;color:var(--text-dim)">(cross-phase)</span></li>`;
      }
    });
    html += `</ul>`;
  }
  html += `</div>`;

  // MVL
  html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">⚡</span> Minimum Viable Lesson</div>`;
  lesson.mvl.forEach(r => {
    html += `<div class="mvl-resource"><div class="res-type">${r.type}</div>${r.text}</div>`;
  });
  html += `</div>`;

  // Concept checks
  html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">✓</span> Concept Checks</div><ul class="concept-check-list">`;
  lesson.conceptChecks.forEach(q => { html += `<li>${q}</li>`; });
  html += `</ul></div>`;

  // Failure modes
  html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">⚠</span> Common Failure Modes</div><ul class="failure-list">`;
  lesson.failureModes.forEach(f => { html += `<li>${f}</li>`; });
  html += `</ul></div>`;

  // Projects
  if (lesson.projects.length > 0) {
    html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">🔨</span> Coding Projects</div><ul class="project-list">`;
    lesson.projects.forEach(p => {
      html += `<li class="project-item"><span class="project-badge ${p.label.toLowerCase()}">${p.label}</span><span>${p.text}</span></li>`;
    });
    html += `</ul></div>`;
  }

  document.getElementById('detail-empty').style.display = 'none';
  document.getElementById('detail-content').style.display = 'block';
  document.getElementById('detail-content').innerHTML = html;

  // Mobile: show as bottom sheet
  if (window.innerWidth <= 900) {
    document.getElementById('detail-panel').classList.add('mobile-open');
    document.getElementById('detail-backdrop').classList.add('open');
  }
}

function selectCheckpoint(cpId) {
  const cp = CHECKPOINTS.find(c => c.id === cpId);
  if (!cp) return;

  let html = `<div class="detail-header">
    <div class="detail-phase-tag" style="color:${getPhaseColor(cp.phase)}">
      <div style="background:${getPhaseColor(cp.phase)};width:6px;height:6px;border-radius:50%"></div>
      Review Checkpoint
    </div>
    <div class="detail-title">${cp.title}</div>
  </div>
  <div class="detail-section"><div class="detail-section-title"><span class="icon">🔗</span> Integration Exercises</div><ul class="concept-check-list">`;
  cp.exercises.forEach(ex => { html += `<li>${ex}</li>`; });
  html += `</ul></div>`;

  document.getElementById('detail-empty').style.display = 'none';
  document.getElementById('detail-content').style.display = 'block';
  document.getElementById('detail-content').innerHTML = html;

  if (window.innerWidth <= 900) {
    document.getElementById('detail-panel').classList.add('mobile-open');
    document.getElementById('detail-backdrop').classList.add('open');
  }
}

function closeMobileDetail() {
  document.getElementById('detail-panel').classList.remove('mobile-open');
  document.getElementById('detail-backdrop').classList.remove('open');
}

// ── View Switching ──
function setView(view) {
  currentView = view;
  document.querySelectorAll('.canvas-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');

  const svg = document.getElementById('graph-svg');
  const calView = document.getElementById('calendar-view');
  const legend = document.getElementById('canvas-legend');

  if (view === 'dependency') {
    svg.style.display = '';
    calView.style.display = 'none';
    legend.style.display = 'flex';
    renderGraph();
  } else if (view === 'timeline') {
    svg.style.display = '';
    calView.style.display = 'none';
    legend.style.display = 'none';
    renderTimeline();
  } else if (view === 'calendar') {
    svg.style.display = 'none';
    calView.style.display = '';
    legend.style.display = 'none';
    renderCalendar();
  }
}

// ── Timeline ──
function renderTimeline() {
  const svg = document.getElementById('graph-svg');
  const rect = svg.parentElement.getBoundingClientRect();
  const w = rect.width;
  const h = rect.height;

  let html = '';
  const margin = { top: 60, left: 60, right: 40, bottom: 40 };
  const usableW = w - margin.left - margin.right;
  const usableH = h - margin.top - margin.bottom;

  const barW = Math.min(20, usableW / LESSONS.length - 2);
  const gap = (usableW - barW * LESSONS.length) / LESSONS.length;

  function parseHours(h) {
    const match = h.match(/(\d+)–(\d+)/);
    if (match) return (parseInt(match[2]) + parseInt(match[3])) / 2;
    return 5;
  }

  const maxH = Math.max(...LESSONS.map(l => parseHours(l.hours)));

  html += `<text x="${margin.left}" y="${margin.top - 25}" fill="var(--text-dim)" font-family="JetBrains Mono, monospace" font-size="11" font-weight="600">ESTIMATED HOURS PER LESSON</text>`;
  html += `<line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${h - margin.bottom}" stroke="var(--border)" stroke-width="1" />`;
  html += `<line x1="${margin.left}" y1="${h - margin.bottom}" x2="${w - margin.right}" y2="${h - margin.bottom}" stroke="var(--border)" stroke-width="1" />`;

  for (let i = 0; i <= maxH; i += 5) {
    const y = h - margin.bottom - (i / maxH) * usableH;
    html += `<text x="${margin.left - 8}" y="${y + 4}" fill="var(--text-dim)" font-family="JetBrains Mono, monospace" font-size="10" text-anchor="end">${i}h</text>`;
    html += `<line x1="${margin.left}" y1="${y}" x2="${w - margin.right}" y2="${y}" stroke="var(--border)" stroke-width="0.5" opacity="0.3" />`;
  }

  LESSONS.forEach((lesson, i) => {
    const x = margin.left + i * (barW + gap) + gap / 2;
    const hrs = parseHours(lesson.hours);
    const barH = (hrs / maxH) * usableH;
    const y = h - margin.bottom - barH;
    const color = getPhaseColor(lesson.phase);

    html += `<rect x="${x}" y="${y}" width="${barW}" height="${barH}" fill="${color}" opacity="${lesson.status === 'complete' ? 0.8 : lesson.status === 'in-progress' ? 0.5 : 0.2}" rx="2" cursor="pointer" onclick="selectLesson(${lesson.id})" />`;
    html += `<text x="${x + barW/2}" y="${h - margin.bottom + 14}" fill="var(--text-dim)" font-family="JetBrains Mono, monospace" font-size="9" text-anchor="middle">${lesson.label || lesson.id}</text>`;
    html += `<text x="${x + barW/2}" y="${y - 5}" fill="${color}" font-family="JetBrains Mono, monospace" font-size="9" text-anchor="middle" opacity="0.7">${hrs}h</text>`;
  });

  svg.innerHTML = html;
}

// ── Calendar ──
function renderCalendar() {
  const container = document.getElementById('calendar-view');
  const cal = loadCalendar();
  const today = new Date();
  const todayKey = dateKey(today.getFullYear(), today.getMonth(), today.getDate());

  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const firstDow = new Date(calYear, calMonth, 1).getDay(); // 0=Sun

  let html = '';

  // Header with nav
  html += `<div class="cal-header">
    <button class="cal-nav" onclick="calPrev()">&larr;</button>
    <div>
      <span class="cal-month-label">${monthNames[calMonth]} ${calYear}</span>
      <button onclick="calToday()" style="background:none;border:1px solid var(--border);color:var(--text-dim);font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 8px;border-radius:3px;cursor:pointer;margin-left:10px;vertical-align:middle">today</button>
    </div>
    <button class="cal-nav" onclick="calNext()">&rarr;</button>
  </div>`;

  // Day-of-week headers
  html += `<div class="cal-grid">`;
  ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d => {
    html += `<div class="cal-dow">${d}</div>`;
  });

  // Empty cells before month start
  for (let i = 0; i < firstDow; i++) {
    html += `<div class="cal-day empty"></div>`;
  }

  // Day cells
  for (let d = 1; d <= daysInMonth; d++) {
    const dk = dateKey(calYear, calMonth, d);
    const isToday = dk === todayKey;
    const isSelected = dk === calSelectedDate;
    const dayLessons = (cal[dk] || []).map(id => LESSONS.find(l => l.id === id)).filter(Boolean);

    let classes = 'cal-day';
    if (isToday) classes += ' today';
    if (isSelected) classes += ' selected';

    html += `<div class="${classes}" onclick="calSelectDay('${dk}')" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="calDrop(event,'${dk}')">`;
    html += `<div class="cal-day-num">${d}</div>`;

    dayLessons.forEach(lesson => {
      const color = getPhaseColor(lesson.phase);
      html += `<div class="cal-chip" style="background:${color}22;color:${color}" onclick="event.stopPropagation();calChipClick(${lesson.id},'${dk}')" title="${lesson.title} — click to view, right-click to remove" oncontextmenu="event.preventDefault();event.stopPropagation();calRemoveLesson(${lesson.id},'${dk}')">`;
      html += `<span class="cal-chip-num">${lesson.label || lesson.id}</span>`;
      html += `<span class="cal-chip-title">${lesson.title}</span>`;
      html += `</div>`;
    });

    html += `</div>`;
  }

  // Empty cells after month end
  const totalCells = firstDow + daysInMonth;
  const remaining = (7 - totalCells % 7) % 7;
  for (let i = 0; i < remaining; i++) {
    html += `<div class="cal-day empty"></div>`;
  }

  html += `</div>`;

  // Lesson pool - always shows all lessons
  const dayCounts = getScheduledDayCounts();
  const unplacedCount = LESSONS.filter(l => !dayCounts[l.id]).length;
  html += `<div class="cal-unscheduled">`;
  html += `<div class="cal-unscheduled-label">LESSON POOL (${unplacedCount} unplaced) — drag onto calendar or select a day and click</div>`;
  html += `<div style="display:flex;flex-wrap:wrap;gap:0">`;

  LESSONS.forEach(lesson => {
    const color = getPhaseColor(lesson.phase);
    const statusIcon = lesson.status === 'complete' ? '●' : lesson.status === 'in-progress' ? '◐' : '○';
    const days = dayCounts[lesson.id] || 0;
    const dimmed = days > 0 ? 'opacity:0.55;' : '';
    html += `<div class="cal-pool-chip" style="background:${color}15;color:${color};${dimmed}" draggable="true" ondragstart="calDragStart(event,${lesson.id})" onclick="calPoolClick(${lesson.id})" title="${lesson.title} (${lesson.hours})${days ? ' — scheduled on ' + days + ' day' + (days>1?'s':'') : ''}">`;
    html += `<span style="font-size:9px">${statusIcon}</span>`;
    html += `<span style="font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700">${lesson.label || lesson.id}</span>`;
    html += `<span style="font-family:'DM Sans',sans-serif;font-size:11px">${lesson.title}</span>`;
    if (days > 0) html += `<span style="font-family:'JetBrains Mono',monospace;font-size:9px;opacity:0.7;margin-left:2px">${days}d</span>`;
    html += `</div>`;
  });

  html += `</div></div>`;

  container.innerHTML = html;
}

function calPrev() {
  calMonth--;
  if (calMonth < 0) { calMonth = 11; calYear--; }
  renderCalendar();
}
function calNext() {
  calMonth++;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  renderCalendar();
}
function calToday() {
  const t = new Date();
  calYear = t.getFullYear();
  calMonth = t.getMonth();
  renderCalendar();
}

function calSelectDay(dk) {
  calSelectedDate = (calSelectedDate === dk) ? null : dk;
  renderCalendar();

  if (calSelectedDate) {
    // Show picker in detail panel
    showDayPicker(dk);
  }
}

function showDayPicker(dk) {
  const cal = loadCalendar();
  const dayLessonIds = cal[dk] || [];
  const dayLessons = dayLessonIds.map(id => LESSONS.find(l => l.id === id)).filter(Boolean);
  const available = LESSONS.filter(l => !dayLessonIds.includes(l.id));
  const dayCounts = getScheduledDayCounts();

  const parts = dk.split('-');
  const dateStr = new Date(parseInt(parts[0]), parseInt(parts[2])-1, parseInt(parts[3]))
    .toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

  let html = `<div class="detail-header">
    <div class="detail-phase-tag" style="color:var(--accent-5)">
      <div style="background:var(--accent-5);width:6px;height:6px;border-radius:50%"></div>
      Calendar
    </div>
    <div class="detail-title">${dateStr}</div>
  </div>`;

  // Scheduled for this day
  if (dayLessons.length > 0) {
    html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">📅</span> Scheduled</div>`;
    dayLessons.forEach(lesson => {
      const color = getPhaseColor(lesson.phase);
      const otherDays = (dayCounts[lesson.id] || 1) - 1;
      const otherNote = otherDays > 0 ? ` <span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim)">+${otherDays} other day${otherDays>1?'s':''}</span>` : '';
      html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0">
        <span style="font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:700;color:${color}">${lesson.label || lesson.id}</span>
        <span style="font-size:12px;flex:1;cursor:pointer" onclick="selectLesson(${lesson.id})">${lesson.title}${otherNote}</span>
        <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-dim)">${lesson.hours}</span>
        <button onclick="calRemoveLesson(${lesson.id},'${dk}')" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:2px 4px" title="Remove from this day">✕</button>
      </div>`;
    });
    html += `</div>`;
  }

  // Add lessons (not already on this day)
  if (available.length > 0) {
    html += `<div class="detail-section"><div class="detail-section-title"><span class="icon">➕</span> Add a Lesson</div>`;

    // Group by phase
    PHASES.forEach(phase => {
      const phaseLessons = available.filter(l => l.phase === phase.id);
      if (phaseLessons.length === 0) return;
      html += `<div style="font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;color:${phase.color};letter-spacing:1px;padding:6px 0 2px;opacity:0.6">${phase.name.toUpperCase()}</div>`;
      phaseLessons.forEach(lesson => {
        const color = getPhaseColor(lesson.phase);
        const days = dayCounts[lesson.id] || 0;
        const daysBadge = days > 0 ? `<span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--text-dim);margin-left:4px">${days}d</span>` : '';
        html += `<div class="picker-lesson" onclick="calAddLesson(${lesson.id},'${dk}')">
          <span class="picker-lesson-num" style="color:${color}">${lesson.label || lesson.id}</span>
          <span>${lesson.title}${daysBadge}</span>
          <span class="picker-hours">${lesson.hours}</span>
        </div>`;
      });
    });
    html += `</div>`;
  }

  document.getElementById('detail-empty').style.display = 'none';
  document.getElementById('detail-content').style.display = 'block';
  document.getElementById('detail-content').innerHTML = html;

  if (window.innerWidth <= 900) {
    document.getElementById('detail-panel').classList.add('mobile-open');
    document.getElementById('detail-backdrop').classList.add('open');
  }
}

function calAddLesson(lessonId, dk) {
  const cal = loadCalendar();
  if (!cal[dk]) cal[dk] = [];
  if (!cal[dk].includes(lessonId)) {
    cal[dk].push(lessonId);
    saveCalendar(cal);
  }
  renderCalendar();
  showDayPicker(dk);
}

function calRemoveLesson(lessonId, dk) {
  const cal = loadCalendar();
  if (cal[dk]) {
    cal[dk] = cal[dk].filter(id => id !== lessonId);
    if (cal[dk].length === 0) delete cal[dk];
    saveCalendar(cal);
  }
  renderCalendar();
  if (calSelectedDate === dk) showDayPicker(dk);
}

function calChipClick(lessonId, dk) {
  selectLesson(lessonId);
}

function calPoolClick(lessonId) {
  if (calSelectedDate) {
    calAddLesson(lessonId, calSelectedDate);
  } else {
    selectLesson(lessonId);
  }
}

// Drag and drop
function calDragStart(ev, lessonId) {
  calDragLesson = lessonId;
  ev.dataTransfer.effectAllowed = 'move';
  ev.target.classList.add('dragging');
  setTimeout(() => { if (ev.target) ev.target.classList.remove('dragging'); }, 200);
}

function calDrop(ev, dk) {
  ev.preventDefault();
  ev.target.closest('.cal-day')?.classList.remove('drag-over');
  if (calDragLesson !== null) {
    const cal = loadCalendar();
    // Add to this day (don't remove from other days — lessons can span multiple days)
    if (!cal[dk]) cal[dk] = [];
    if (!cal[dk].includes(calDragLesson)) cal[dk].push(calDragLesson);
    saveCalendar(cal);
    calDragLesson = null;
    renderCalendar();
    if (calSelectedDate === dk) showDayPicker(dk);
  }
}


// ═══════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════

function init() {
  loadStatuses();
  renderSidebar();
  renderGraph();
  updateStats();
  window.addEventListener('resize', () => {
    if (currentView === 'dependency') renderGraph();
    else if (currentView === 'timeline') renderTimeline();
  });
}

init();
</script>
</body>
</html>
